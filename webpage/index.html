<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>US Transit</title>
        <script src="https://d3js.org/d3.v4.min.js"></script>
        <script src="https://d3js.org/topojson.v3.min.js"></script>
        <style type="text/css">
        .states {
            fill: #e5e5e5;
            stroke: #fff;
            stroke-width:2px;
        }
        .states:hover {
            fill: steelblue;
        }
        #titlebar {
            text-align: center;
        }
        #body {
            width: 100%;
        }
        #interactive {
            margin: 0 auto;
            width: 1100px;
        }
        #left-input {
            display: inline-block;
        }
        select {
            width: 125px;
        }
        #right-map {
            float: right;
        }
        div.tooltip {
            position: absolute;
            text-align: center;
            padding: 2px;
            font: 12px sans-serif;
            background: lightsteelblue;
            border: 0px;
            border-radius: 8px;
            pointer-events: none;
        }
        </style>
    </head>
    <body>
        <div id="titlebar"><h1>US Transit</h1></div>
        <div id="body">
            <div id="interactive">
                <form id="left-input">
                </form>
                <svg width="960" height="600" id="right-map"></svg>
            </div>
        </div>
    </body>
    
    <script>
        var width = 960
        var height = 500
        
        var svg = d3.select('#right-map')
        
        // load map of us states
        var projection = d3.geoAlbersUsa()
            .scale(1000)
            .translate([width / 2, height / 2])
        
        var path = d3.geoPath()
            .projection(projection)

        var dScale = projection.scale()
        var dTranslate = projection.translate()

        // load in transit data
        d3.csv("transit.csv", function(transit)
        {
            // column names and current selections
            var columns = ["STATE", "SYSTEM", "RTE_NAME", "ZIP", "bracket"]
            var selections = ["ALL", "ALL", "ALL", "ALL", "ALL"]

            // creates a tooltip object for hover over
            var ttip = d3.select("body").append("div")	
                .attr("class", "tooltip")				
                .style("opacity", 0);

            // load in map data to draw states
            d3.json('us.json', function(error, us)
            {
                // create and populate a dropdown for state
                state = createDropdown("#left-input", "State", function(d) {
                    selections[0] = d3.select(this).property("value")

                    // zoom in on the selected state
                    if(selections[0] == 'ALL') {
                        resetZoom()
                    }
                    else {
                        for(i in topojson.feature(us, us.objects.usStates).features) {
                            var d = topojson.feature(us, us.objects.usStates).features[i]
                            if(d.properties.STATE_ABBR == selections[0]) {
                                selectState(selections[0], d)
                                break
                            }
                        }
                    }
                    plotData()

                    populateDropdown(system, addAll(unique(select(transit, ["STATE"], [selections[0]]), "SYSTEM")))
                    populateDropdown(zip, addAll(unique(select(transit, ["STATE"], [selections[0]]), "ZIP")))
                    populateDropdown(route, addAll(unique(select(transit, ["STATE"], [selections[0]]), "RTE_NAME")))
                })
                populateDropdown(state, addAll(unique(transit, "STATE")))

                // create and populate a dropdown for system
                system = createDropdown("#left-input", "System", function(d) {
                    selections[1] = d3.select(this).property("value")
                    plotData()
                    populateDropdown(zip, addAll(unique(select(transit, ["SYSTEM"], [selections[1]]), "ZIP")))
                    populateDropdown(route, addAll(unique(select(transit, ["SYSTEM"], [selections[1]]), "RTE_NAME")))
                })
                populateDropdown(system, addAll(unique(transit, "SYSTEM")))

                // create and populate a dropdown for route
                route = createDropdown("#left-input", "Route", function(d) {
                    selections[2] = d3.select(this).property("value")
                    plotData()
                    populateDropdown(zip, addAll(unique(select(transit, ["RTE_NAME"], [selections[2]]), "ZIP")))
                })
                populateDropdown(route, addAll(unique(transit, "RTE_NAME")))

                // create and populate a dropdown for zip code
                zip = createDropdown("#left-input", "Zipcode", function(d) {
                    selections[3] = d3.select(this).property("value")
                    plotData()
                })
                populateDropdown(zip, addAll(unique(transit, "ZIP")))

                // create and populate a dropdown for income level
                income = createDropdown("#left-input", "Income Level", function(d) {
                    selections[4] = d3.select(this).property("value")
                    plotData()
                })
                populateDropdown(income, addAll(unique(transit, "bracket")))

                // create all states
                var p = svg.selectAll('.states')
                    .data(topojson.feature(us, us.objects.usStates).features)
                    .enter()
                    .append('path')
                    .attr('class', 'states')
                    .attr('d', path)
                    .on('click', function(d) {
                        // select a state by clicking it
                        var name = d.properties.STATE_ABBR
                        selectState(name, d)
                    })
                
                plotData()
                
                // create reset button
                var left = d3.select("#left-input")
                left.append("br")
                left.append("br")
                left.append("button").attr('id', 'reset').attr('type', 'button').text('Reset Zoom')
                    .on('click', function(d) {
                        selections[0] = "ALL"
                        d3.select("#State").property("value", 'ALL')
                        resetZoom()
                        plotData()
                    })

                // reset zoom on map
                function resetZoom() {
                    projection.translate(dTranslate)
                    projection.scale(dScale)
                    p.attr('d', path)
                }

                // zoom in on a given state
                function selectState(name, d) {
                    selections[0] = name
                    selections[1] = "ALL"
                    selections[2] = "ALL"
                    selections[3] = "ALL"
                    d3.select("#State").property("value", name)

                    // get the current state of the map
                    var currScale = projection.scale()
                    var currTranslate = projection.translate()

                    // calculate translation and scale
                    var bounds = path.bounds(d)
                    // distance from the edges
                    var dx = bounds[1][0] - bounds[0][0]
                    var dy = bounds[1][1] - bounds[0][1]
                    // center point
                    var x = (bounds[0][0] + bounds[1][0]) / 2
                    var y = (bounds[0][1] + bounds[1][1]) / 2
                    var scale = 0.95 / Math.max(dx / width, dy / height)
                    var translate = [width/2 + scale*(currTranslate[0] - x), height/2 + scale*(currTranslate[1] - y)]

                    // apply translate and sclae
                    projection.translate(translate)
                    projection.scale(scale * currScale)
                    p.attr('d', path)
                    plotData()
                }
            })

            // function to plot current selected data on the map
            function plotData()
            {
                var data = select(transit, columns, selections)
                svg.selectAll("circle").remove()
                svg.selectAll("circle")
                    .data(data).enter()
                    .append("circle")
                    .attr("transform", function (d) { return "translate(" + projection([d.LONGITUDE, d.LATITUDE]) + ")"})
                    .attr("r", "2px")
                    .attr("fill", "red")
                    .on('mouseover', function(d) {
                        // on mouse over show name and income in tooltip
                        var name = d.STATION
                        var income = d.income
                        console.log(name + " $" + income)
                        ttip.transition()
                            .duration(200)
                            .style("opacity", 0.9)
                        ttip.html(name + "<br>$" + income)
                            .style("left", d3.event.pageX + "px")
                            .style("top", (d3.event.pageY - 28) + "px")
                    })
                    .on('mouseout', function(d) {
                        // hide tooltip on mouseout
                        ttip.transition()
                            .duration(500)
                            .style("opacity", 0)
                    })
                    .on('click', function(d) {
                        // filter by route by clicking
                        var route = d.RTE_NAME
                        selections[2] = route
                        d3.select("#Route").property("value", route)
                        plotData()
                    })
            }
        })

        // function to create a dropdown (select)
        function createDropdown(parentName, name, onChange)
        {
            parent = d3.select(parentName)
            title = parent.append("h4")
            title.html(name)
            dropdown = parent.append("select")
            dropdown.attr("name", name)
                .attr("id", name)
                .on("change", onChange)
            return dropdown
        }

        // function to populate a dropdown (select)
        function populateDropdown(dropdown, options)
        {
            dropdown.selectAll('option').remove()
            dropdown.selectAll('option')
                .data(options).enter()
                .append("option")
                .attr("value", function (d) { return d })
                .text(function (d) { return d })
        }

        // function to select data based on a list of keys and values
        function select(data, keys, values)
        {
            result = [];
            data.forEach(function(row)
            {
                var passed = true
                for(i in keys)
                {
                    if(values[i] != "ALL" && row[keys[i]] != values[i])
                    {
                        passed = false
                    }
                }
                if(passed)
                {
                    result.push(row)
                }
            })
            return result
        }

        // function to get all unique values for a key
        function unique(data, key)
        {
            result = [];
            data.forEach(function(row)
            {
                value = row[key]
                if(!result.includes(value))
                {
                    result.push(value)
                }
            })
            return result.sort()
        }

        // function to add "ALL" to the begining of a list
        function addAll(list)
        {
            list.unshift('ALL')
            return list
        }
    </script>
</html>